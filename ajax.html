<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ajax</title>
</head>
<body>
<script type="module">
    function ajax(url, onSuccess, onFailed) {
      // 创建xhr
      const xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTML")
      // 连接服务器
      xhr.open('GET', url, true)
      // 发送
      xhr.send()
      // 带上cookie
      // xhr.withCredentials = true
      // 接收
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            onSuccess && onSuccess(xhr.responseText)
          } else {
            onFailed && onFailed()
          }
        }
      }
    }
    // ajax('http://localhost:63342/domAjax/data.json', res => console.log(res))
    // fetch('http://localhost:63342/domAjax/data.json')
    // .then(res => res.json())
    // .then(res => console.log(res))

    let cc = null
    const mitt = {
      cache: {},
      on(name, func) {
        this.cache[name] = func
      },
      emit(name, data) {
        const fn = this.cache[name]
        fn && fn(data)
      }
    }

    function adaptor(config) {
      return new Promise((resolve, reject) => {
        let request = new XMLHttpRequest()
        request.open(
          config.method.toUpperCase(),
          config.url,
          true
        )
        request.send()
        request.timeout = config.timeout
        request.onabort = function () {
          reject('[abort] request is abort')
          request = null
        }
        if (config.cancel) {
          // config.cancel(
            mitt.emit('abort', function () {
              request.abort()
              request = null
              reject('[abort] current request is abort')
            })
          // );
        }

        request.onreadystatechange = function () {
          if(request.readyState === 4) {
            if (request.status === 200) {
              setTimeout(() => {
                resolve(request && request.responseText)
              }, 5000)
            } else {
              reject('reject error')
            }
          }
        }
      })
    }

    function dispathRequest(config) {
      return adaptor(config).then(function (response) {
        return response
      }, function (reason) {
        return Promise.reject(reason)
      })
    }

    function req(config = {}) {
      const chain = [dispathRequest, undefined]
      if(config.interceptor) {
        chain.unshift(
          config.interceptor.fullfilled,
          config.interceptor.rejected
        )
      }

      if (config.cancel) {
        mitt.on('abort', function (cancel) {
          config.cancel(cancel)
        })
      }

      if (config.adaptor) {
        chain.push(
          config.adaptor.fullfilled,
          config.adaptor.rejected
        )
      }
      let promise = Promise.resolve(config)
      while (chain.length) {
        promise = promise.then(chain.shift(), chain.shift())
      }
      return promise
    }

    req({
      url: 'http://localhost:63342/domAjax/data.json',
      method: 'get',
      interceptor: {
        fullfilled: res => {
          console.log('请求拦截成功', res)
          return res
        }
      },
      adaptor: {
        fullfilled: res => {
          console.log('响应拦截成功', res)
          return res
        }
      },
      cancel(c) {
        cc = c
      }
    }).then(res => console.log(res))
    setTimeout(() => {
      cc && cc()
    }, 3000)
</script>
</body>
</html>
